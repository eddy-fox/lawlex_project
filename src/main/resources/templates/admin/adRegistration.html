<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>광고 등록</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/all/adInfo.css}">
</head>
<body>
    <!-- 헤더 -->
    <div class="include" th:replace="~{include/header :: header}"></div>

    <!-- 메인 -->
    <main class="page-adinfo">

      <!-- 사이드 바 -->
      <div class="sideMenu" th:replace="~{include/aSide :: aSide}"></div>

      <div class="container">

        <!-- 광고 등록 -->
        <form th:action="@{/admin/adRegistration}" method="post" class="ad-card"
            th:object="${adRegistration}" enctype="multipart/form-data">

          <div class="form-grid">
            <div class="small">광고 이름:</div>
            <input class="input name" type="text" th:field="*{adName}" id="adName" />

            <div class="small">신청자:</div>
            <div class="input-group">
              <input class="input lawyer" type="text" id="lawyerName" />
              <button type="button" class="btn btn-find" id="findLawyerBtn">찾기</button>
            </div>
            <input type="hidden" th:field="*{lawyerIdx}" id="lawyerIdx" />
            
            <div class="small">게시일:</div>
            <input class="input date" type="date" th:field="*{adStartDate}" id="adStartDate" />

            <div class="small">게시기간:</div>
            <select class="input date" th:field="*{adDuration}" id="adDuration">
                <option th:value="7" th:text="'7일'"></option>
                <option th:value="14" th:text="'14일'"></option>
                <option th:value="21" th:text="'21일'"></option>
                <option th:value="28" th:text="'28일'"></option>
            </select>

            <div class="small">이미지</div>
            <div class="input-group">
                <!-- 사용자에게 보여줄 원본 파일 -->
              <input class="input img" type="text" id="imgUrl" readonly placeholder="선택된 파일명"/>
              <button type="button" class="btn btn-find" id="findImgBtn">찾아보기</button>
            </div>
            <!-- 받아온 원본 파일 -->
            <div class="small">이미지 미리보기</div>
            <input id="adImageFile" type="file" accept="image/*" style="display:none">
            <div class="form-thumb">
              <img id="previewImg" alt="미리보기">
            </div>
            <!-- 원본 파일 전달 -->
            <input type="hidden" th:field="*{adImgPath}" id="adImgPath" />

            <div class="small">링크</div>
            <input class="input full" type="url" th:field="*{adLink}" id="linkInput" />
          </div>
        
          <div class="actions-row">
            <button type="submit" id="submitBtn" class="btn">등록하기</button>
          </div>

        </form>

      </div>
    </main>

    <!-- 푸터 -->
    <div class="include" th:replace="~{include/footer :: footer}"></div>

</body>

<!-- 사이드바 -->
<script src="/js/admin.js"></script>
<script>
    // 다음주 월요일 계산 함수
    function getNextMonday() {
        const today = new Date();
        const day = today.getDay(); // 0:일, 1:월, ..., 6:토
        const diff = (8 - day) % 7; // 다음주 월요일까지 남은 일수
        const nextMonday = new Date(today);
        nextMonday.setDate(today.getDate() + diff);
        nextMonday.setHours(0,0,0,0); // 00:00
        return nextMonday;
    }

    window.addEventListener('DOMContentLoaded', (event) => {
        const nextMonday = getNextMonday();
        const yyyy = nextMonday.getFullYear();
        const mm = String(nextMonday.getMonth() + 1).padStart(2, '0'); // 월은 0~11
        const dd = String(nextMonday.getDate()).padStart(2, '0');

        // input[type="text"]에 yyyy-MM-dd 형태로 세팅
        document.getElementById('adStartDate').value = `${yyyy}-${mm}-${dd}`;
    });

    // 변호사 찾기 팝업
    document.addEventListener("DOMContentLoaded", function() {
        const btn = document.getElementById("findLawyerBtn");
        const input = document.getElementById("lawyerName");

        btn.addEventListener("click", function() {
            const name = input.value.trim();
            const popupUrl = `/admin/lawyerSearch?lawyerName=${encodeURIComponent(name)}`;

            // 팝업 창 열기
            window.open(
            popupUrl,
            "lawyerSearchPopup",
            "width=1000,height=600,scrollbars=yes,resizable=no"
            );
        });
    });

    // 이미지 넣기
    document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("findImgBtn");
        const fileInput = document.getElementById("adImageFile");
        const imgUrlInput = document.getElementById("imgUrl"); 
        const hiddenPathInput = document.getElementById("adImgPath");
        const preview = document.getElementById("previewImg");

        btn.addEventListener("click", () => fileInput.click());

        fileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // 1) 사용자에게는 원본 파일명 보여주기
            imgUrlInput.value = file.name;

            // 2) 미리보기 표시 
            const reader = new FileReader();
            reader.onload = (ev) => {
            preview.src = ev.target.result;
            preview.style.display = "block";
            };
            reader.readAsDataURL(file);

            // 3) 서버에 저장할 '내가 지정한 이름' 생성, 원본에서 확장자 추출
            const orig = file.name;
            const dotIndex = orig.lastIndexOf('.');
            const ext = dotIndex !== -1 ? orig.substring(dotIndex) : '';
            const desiredName = "ad" + Date.now() + ext;

            // 히든 필드에 저장 (서버에서 이 값을 읽어 업로드 시 사용)
            hiddenPathInput.value = desiredName;

            // 폼 제출 시 유효성 검사
            const form = document.getElementById('adRegistrationForm');

            form.addEventListener('submit', function(e) {
                const requiredFields = [
                    document.getElementById('adName'),
                    document.getElementById('adStartDate'),
                    document.getElementById('adDuration'),
                    document.getElementById('adImgPath'),
                    document.getElementById('linkInput')
                ];

                const isEmpty = requiredFields.some(input => !input.value || input.value.trim() === "");
                if (isEmpty) {
                    e.preventDefault();
                    alert("모든 값을 입력해주세요.");
                    return false;
                }
            });
        });
    });
</script>
</html>
