<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>변호사 채팅</title>
    <link rel="stylesheet" th:href="@{/css/lChating.css}">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<div class="include" th:replace="~{include/header :: header}"></div>

<main class="page-lChating">
  <div class="container">
    <section class="room" aria-label="채팅방">

      <!-- 상단: 상대 이름 + 남은시간 -->
      <header class="head">
        <img src="" class="pic" alt="프로필">
        <div class="info">
          <!-- 변호사 입장에서 상대는 member -->
          <div class="name" th:text="${room != null} ? ${room.chatroomName} : '닉네임'">닉네임</div>
          <div class="timewin"
               th:if="${room != null and room.requestedAt != null}">
            신청시각:
            <span th:text="${#temporals.format(room.requestedAt, 'yyyy-MM-dd HH:mm')}"></span>
          </div>
        </div>
        <div class="badges">
          <!-- 남은시간 표시용: JS가 갱신할 거라 span에 id만 주자 -->
          <span class="remain" id="remainTime"
                th:attr="data-expires-at=${room.expiresAt}"
                >남은시간 --:--</span>
        </div>
      </header>

      <!-- 메시지 영역 -->
      <div class="msgs" id="msgs">
        <!-- 서버에서 내려준 initBatch를 순서대로 렌더링 -->
        <div th:each="msg : ${initBatch}">
          <!-- 날짜칩은 JS로 올려도 되는데, 일단 여기선 말풍선만 -->
          <div class="msg-row"
               th:classappend="${msg.senderType} == 'LAWYER' ? ' user' : ' lawyer'">
            <!-- 내가 보낸거면 시간 먼저 -->
            <div class="meta"
                 th:if="${msg.senderType} == 'LAWYER'"
                 th:text="${#temporals.format(msg.chatRegDate, 'HH:mm')}">12:41</div>

            <!-- 텍스트 -->
            <div class="bubble" th:text="${msg.chatContent}">안녕하세요</div>

            <!-- 상대가 보낸거면 시간 뒤에 -->
            <div class="meta"
                 th:if="${msg.senderType} != 'LAWYER'"
                 th:text="${#temporals.format(msg.chatRegDate, 'HH:mm')}">12:41</div>

            <!-- 첨부가 있으면 밑에 그리도록 div 하나 더 -->
            <div th:if="${msg.attachments != null and !msg.attachments.isEmpty()}"
                 class="media" style="margin-top:6px;">
              <a th:each="att : ${msg.attachments}"
                 th:href="@{'/chat/attachment/' + ${att.attachmentId}}"
                 target="_blank">
                <img th:src="@{'/chat/attachment/' + ${att.attachmentId}}"
                     alt="첨부파일">
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- 입력영역 -->
      <div class="dock">
        <div class="previews" id="previews" aria-live="polite"></div>
        <div class="inputbar">
          <div class="toolbar">
            <button class="icon-btn" id="btnUpload" title="사진 올리기" aria-label="사진 올리기">
              <!-- svg 그대로 -->
              <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 7a2 2 0 0 1 2-2h2.5l1-1h5l1 1H18a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7z" fill="none" stroke="#5160a7" stroke-width="1.6" stroke-linejoin="round" />
                <circle cx="12" cy="13" r="3" fill="none" stroke="#5160a7" stroke-width="1.6" />
                <path d="M12 8v-3M10.5 6.5h3" stroke="#5160a7" stroke-width="1.6" stroke-linecap="round" />
              </svg>
            </button>
            <input type="file" id="fileUpload" class="sr-only" accept="image/*" multiple>
          </div>
          <textarea class="few" id="inputMsg" placeholder="메시지를 입력하세요"></textarea>
          <button class="send" id="btnSend">보내기</button>
        </div>
      </div>

      <!-- 현재 방 정보 hidden 으로 내려주기 (JS에서 필요) -->
      <input type="hidden" id="roomId" th:value="${room != null} ? ${room.chatroomIdx} : 0">
      <input type="hidden" id="senderType" value="LAWYER">
      <input type="hidden" id="senderId"
             th:value="${#authentication?.principal?.lawyerIdx} ?: ${session.loginLawyer != null} ? ${session.loginLawyer.lawyerIdx} : 0" />
             <!-- 위 줄은 네 세션 구조에 맞게 바꿔 -->

    </section>
  </div>

  <!-- 이미지 뷰어는 그대로 -->
  <aside class="viewer" id="viewer" aria-hidden="true" aria-label="이미지 뷰어">
    <div class="stage"><img id="viewerImg" alt="원본 이미지" /></div>
    <div class="ctrl">
      <button type="button" id="btnFit">100%</button>
      <button type="button" id="btnClose">닫기</button>
    </div>
    <button type="button" class="arrow prev" id="btnPrev" aria-label="이전">‹</button>
    <button type="button" class="arrow next" id="btnNext" aria-label="다음">›</button>
  </aside>
</main>

<div class="include" th:replace="~{include/footer :: footer}"></div>
<script th:src="@{/js/js.js}"></script>
<script th:src="@{/js/lChating.js}"></script>
</body>
</html>
