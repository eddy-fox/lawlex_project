<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title th:text="${room != null} ? '채팅방 #' + ${room.chatroomIdx} : '채팅방'">채팅방</title>
  <link rel="stylesheet" th:href="@{/css/lChating.css}">
  <link th:href="@{/css/style.css}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script>
    // Stomp 라이브러리 로드 확인
    window.addEventListener('load', function() {
      if (typeof Stomp === 'undefined') {
        console.error('[DEBUG] Stomp library failed to load');
      } else {
        console.log('[DEBUG] Stomp library loaded successfully');
      }
    });
  </script>
</head>
<body>
<main class="page-lChating">
  <div class="container">
    <div class="room"
         th:attr="data-room-id=${room != null ? room.chatroomIdx : 0},
                  data-me-lawyer-id=${meLawyerIdx != null ? meLawyerIdx : 0},
                  data-room-state=${room != null ? room.state : ''}">

      <!-- ===== 상단 헤더 ===== -->
      <header class="head">
        <div class="pic">
          <!-- 일반회원 프로필 사진 / 없으면 이니셜 -->
          <span th:text="${member != null and member.memberName != null and !member.memberName.isEmpty() ? member.memberName.substring(0, 1) : 'M'}">
            M
          </span>
        </div>

        <div class="info">
          <div class="name"
               th:text="${member != null and member.memberName != null and !member.memberName.isEmpty() ? member.memberName : '일반회원'}">
            일반회원 이름
          </div>
          <div class="timewin" th:if="${room != null}">
            상담 신청 시간
            <span th:text="${#temporals.format(room.requestedAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 12:00</span>
            <span th:if="${room.durationMinutes != null}">
              &nbsp;(~ 약 <span th:text="${room.durationMinutes}">60</span>분)
            </span>
          </div>
        </div>

        <div class="badges">
          <!-- 남은 시간 -->
          <span id="remainTime"
                class="remain"
                th:if="${room != null and room.expiresAt != null}"
                th:attr="data-expires-at=${#temporals.format(room.expiresAt,'yyyy-MM-dd''T''HH:mm:ss')}">
            남은시간 00:00
          </span>
        </div>
      </header>

      <!-- ===== 메시지 영역 ===== -->
      <div id="msgs" class="msgs">
        <!-- 초기 메시지 배치 렌더 -->
        <th:block th:each="m, iterStat : ${initBatch}">
          <!-- 마지막 읽은 메시지 이후 마커 표시 (메시지 앞에, 별도 row로) -->
          <!-- 조건: lastReadChatIdx가 null이 아니고, 현재 메시지가 마지막 읽은 메시지보다 크고, 이전 메시지가 마지막 읽은 메시지보다 작거나 같을 때 -->
          <div th:if="${lastReadChatIdx != null and m.chatIdx > lastReadChatIdx and (iterStat.index == 0 or initBatch[iterStat.index - 1].chatIdx <= lastReadChatIdx)}"
               class="read-marker-row"
               style="width: 100%; text-align: center; padding: 8px 0; color: #64748b; font-size: 12px; border-top: 1px solid #e5e7eb; margin: 8px 0;">
            ---여기까지 읽었습니다---
          </div>

          <div th:class="'msg-row ' + (${m.senderType} == 'LAWYER' ? 'user' : 'lawyer')"
               th:attr="data-chat-idx=${m.chatIdx}">

          <!-- 내가 보낸 메시지(LAWYER) → 오른쪽, 시간 먼저 -->
          <div th:if="${m.senderType == 'LAWYER'}" class="meta"
               th:text="${#temporals.format(m.chatRegDate,'HH:mm')}">12:34</div>

          <div th:if="${m.chatContent != null}" class="bubble">
            <div th:text="${m.chatContent}">메시지 내용</div>
          </div>

          <!-- 첨부 이미지가 있을 때 (텍스트와 같은 위치에 배치) -->
          <div th:if="${m.attachments != null and !m.attachments.isEmpty()}"
               class="media">
            <a th:each="att : ${m.attachments}"
               th:if="${att.fileUrl != null}"
               th:href="${att.fileUrl}"
               target="_blank">
              <img th:src="${att.fileUrl}"
                   th:alt="${att.fileName != null ? att.fileName : '첨부파일'}">
            </a>
          </div>

          <!-- 상대(일반회원)가 보낸 메시지 → 왼쪽, 말풍선 뒤에 시간 -->
          <div th:if="${m.senderType == 'MEMBER'}" class="meta"
               th:text="${#temporals.format(m.chatRegDate,'HH:mm')}">12:34</div>
          </div>
        </th:block>
      </div>

      <!-- ===== 입력 영역 (로그인된 변호사만) ===== -->
      <div class="dock" th:if="${meLawyerIdx != null}">
        <!-- 이미지 미리보기 -->
        <div id="previews" class="previews"></div>

        <div class="inputbar">
          <div class="toolbar">
            <button type="button" id="btnUpload" class="icon-btn" aria-label="이미지 첨부"
                    th:disabled="${room != null and room.state != 'ACTIVE'}">
              +
            </button>
            <input type="file" id="fileUpload" accept="image/*" multiple hidden>
          </div>

          <textarea id="inputMsg" class="few"
                    th:placeholder="${room != null and room.state != 'ACTIVE' ? '상담이 종료되었습니다' : '메시지를 입력하세요'}"
                    th:disabled="${room != null and room.state != 'ACTIVE'}"
                    autocomplete="off"></textarea>

          <button id="btnSend" type="button" class="send"
                  th:disabled="${room != null and room.state != 'ACTIVE'}">전송</button>
        </div>
      </div>

      <!-- 비로그인/세션 만료 시 -->
      <div class="dock" th:if="${meLawyerIdx == null}">
        <div class="inputbar">
          <textarea class="few" disabled>로그인이 필요합니다.</textarea>
          <button class="send" type="button" disabled>전송</button>
        </div>
      </div>

      <!-- ===== 숨겨진 값들: JS에서 사용 ===== -->
      <input type="hidden" id="roomId"
             th:value="${room != null ? room.chatroomIdx : 0}">
      <input type="hidden" id="senderType" value="LAWYER">
      <input type="hidden" id="senderId"
             th:value="${meLawyerIdx != null ? meLawyerIdx : 0}">
      <input type="hidden" id="expiresAt"
             th:if="${room != null and room.expiresAt != null}"
             th:value="${#temporals.format(room.expiresAt,'yyyy-MM-dd''T''HH:mm:ss')}">
    </div>

    <!-- ===== 라이트박스 (이미지 클릭 확대) ===== -->
    <div id="viewer" class="viewer" aria-hidden="true">
      <div class="stage">
        <img id="viewerImg" src="" alt="확대 이미지">
      </div>
      <div class="ctrl">
        <button type="button" id="btnFit">100%</button>
        <button type="button" id="btnClose">닫기</button>
      </div>
      <button type="button" id="btnPrev" class="arrow prev">&#10094;</button>
      <button type="button" id="btnNext" class="arrow next">&#10095;</button>
    </div>
  </div>
</main>

<!-- 전역 JS (chatIcon, sideMenu, gChating/lChating 스크립트 포함) -->
<script th:src="@{/js/js.js}"></script>
<script th:src="@{/js/chatIcon.js}"></script>
<script th:src="@{/js/lChating.js}"></script>
</body>
</html>
