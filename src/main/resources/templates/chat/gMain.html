<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>채팅메인 일반회원</title>
  <link rel="stylesheet" th:href="@{/css/gMain.css}">
  <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<div class="include" th:replace="~{include/header :: header}"></div>

<main class="page-gMain">
  <div class="container">

    <!-- 요일 선택 -->
    <div class="weekday" id="weekday" style="margin-bottom:16px;">
      <a class="chip"
         th:classappend="${selectedDow} == 0 ? ' is-active' : ''"
         th:href="@{/chat/member(dow=0, duration=${duration})}">월요일</a>
      <a class="chip"
         th:classappend="${selectedDow} == 1 ? ' is-active' : ''"
         th:href="@{/chat/member(dow=1, duration=${duration})}">화요일</a>
      <a class="chip"
         th:classappend="${selectedDow} == 2 ? ' is-active' : ''"
         th:href="@{/chat/member(dow=2, duration=${duration})}">수요일</a>
      <a class="chip"
         th:classappend="${selectedDow} == 3 ? ' is-active' : ''"
         th:href="@{/chat/member(dow=3, duration=${duration})}">목요일</a>
      <a class="chip"
         th:classappend="${selectedDow} == 4 ? ' is-active' : ''"
         th:href="@{/chat/member(dow=4, duration=${duration})}">금요일</a>
    </div>

    <!-- 변호사 카드 목록 -->
    <section class="cards" id="cards">

      <article class="card" th:each="law : ${lawyers}">
        <div class="photo">
          <img th:if="${law.imgPath != null}"
               th:src="${law.imgPath}"
               alt="변호사 사진"
               style="width:100%;height:100%;object-fit:cover;border-radius:10px;">
          <span th:if="${law.imgPath == null}">사진</span>
        </div>

        <div class="info">
          <h3 class="name" th:text="${law.name}">변호사</h3>
          <div class="meta">
            <div>상담가능시간</div>
            <div th:text="${law.timeRange ?: '정보없음'}">11:00 ~ 14:00</div>
          </div>
        </div>

        <!-- 신청 폼 (중첩 form 금지: 폼은 이거 하나만) -->
        <form th:action="@{/chat/request}" method="post" class="card-form" style="margin-top:10px;">
          <input type="hidden" name="lawyerIdx" th:value="${law.lawyerIdx}">

          <div class="duration-choice" style="margin-bottom:8px;">
            <label style="margin-right:8px;">
              <input type="radio" name="durationMinutes" value="30"
                     th:disabled="${law.can30 == null or !law.can30}"
                     th:checked="${law.can30 != null and law.can30}">
              30분 (100P)
            </label>

            <label>
              <input type="radio" name="durationMinutes" value="60"
                     th:disabled="${law.can60 == null or !law.can60}"
                     th:checked="${(law.can60 != null and law.can60) and (law.can30 == null or !law.can30)}">
              60분 (200P)
            </label>
          </div>

          <button class="btn" type="submit"
                  th:disabled="${law.canRequestNow == null or !law.canRequestNow}"
                  th:text="${(law.canRequestNow ?: false) ? '신청' : '지금은 신청 불가'}"
                  th:classappend="${(law.canRequestNow ?: false) ? '' : ' cancel'}">
            신청
          </button>

          <input type="hidden" th:if="${_csrf != null}"
                 th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </form>
      </article>

      <p class="empty" th:if="${#lists.isEmpty(lawyers)}">
        해당 요일에 상담 가능한 변호사가 없습니다.
      </p>
    </section>

  </div>
</main>

<div class="include" th:replace="~{include/footer :: footer}"></div>

<script th:src="@{/js/js.js}"></script>
<script th:src="@{/js/chatIcon.js}"></script>
<script th:if="${errorMessage != null}" th:inline="javascript">
  (function() {
    var errorMsg = decodeURIComponent(/*[[${errorMessage}]]*/ '');
    if (errorMsg) {
      alert(errorMsg);
      // URL에서 error 파라미터 제거 (뒤로가기 시 alert가 다시 뜨지 않도록)
      var url = new URL(window.location.href);
      url.searchParams.delete('error');
      window.history.replaceState({}, '', url);
    }
  })();
</script>
<script th:if="${successMessage != null}" th:inline="javascript">
  (function() {
    var message = decodeURIComponent(/*[[${successMessage}]]*/ '');
    if (message) {
      alert(message);
      // URL에서 success 파라미터 제거 (뒤로가기 시 alert가 다시 뜨지 않도록)
      var url = new URL(window.location.href);
      url.searchParams.delete('success');
      window.history.replaceState({}, '', url);
    }
  })();
</script>
<script th:if="${alert}" th:inline="javascript">
        /*<![CDATA[*/
        alert('[[${alert}]]'); // 전달된 alert 메세지 출력
        /*]]>*/
    </script>
</body>
</html>
