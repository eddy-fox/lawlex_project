<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>일반회원챗</title>
    <link rel="stylesheet" th:href="@{/css/gChating.css}">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<div class="include" th:replace="~{include/header :: header}"></div>

<main class="page-gChating">
  <div class="container">

    <!-- JS가 쓸 숨겨진 값들 -->
    <input type="hidden" id="roomId" th:value="${room.chatroomIdx}">
    <input type="hidden" id="senderType" value="MEMBER">
    <input type="hidden" id="senderId" th:value="${loginMember.memberIdx}">
    <input type="hidden" id="expiresAt" th:value="${room.expiresAt}">

    <section class="room" aria-label="채팅방">
      <header class="head">
        <img src="" class="pic" alt="프로필">
        <div class="info">
          <!-- 방 이름이 변호사 이름에 가까울 거라고 가정 -->
          <div class="name" th:text="${room.chatroomName}">000변호사</div>
          <!-- 상담가능시간은 일단 서버에서 안 주니까 방 이름 밑에 설명만 간단히 -->
          <div class="timewin">
            <!-- 필요하면 나중에 calendarService 결과로 교체 -->
            상담 중입니다
          </div>
        </div>
        <div class="badges">
          <span class="remain" id="remainTime"
                th:if="${room.expiresAt != null}"
                th:text="'남은시간 계산중...'">남은시간 14:22</span>
        </div>
      </header>

      <!-- 메시지 영역 -->
      <div class="msgs" id="msgs">
        <!-- 입장 시점에 서버가 내려준 메시지들 뿌리기 -->
        <div th:if="${initBatch != null}"
             th:each="msg : ${initBatch}"
             th:insert="~{::messageRow(msg=${msg}, loginMember=${loginMember})}"></div>
      </div>

      <!-- 입력 영역 -->
      <div class="dock">
        <div class="previews" id="previews" aria-live="polite"></div>
        <div class="inputbar">
          <div class="toolbar">
            <button class="icon-btn" id="btnUpload" title="사진 올리기" aria-label="사진 올리기" type="button">
              <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 7a2 2 0 0 1 2-2h2.5l1-1h5l1 1H18a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7z"
                      fill="none" stroke="#5160a7" stroke-width="1.6" stroke-linejoin="round" />
                <circle cx="12" cy="13" r="3" fill="none" stroke="#5160a7" stroke-width="1.6" />
                <path d="M12 8v-3M10.5 6.5h3" stroke="#5160a7" stroke-width="1.6" stroke-linecap="round" />
              </svg>
            </button>
            <input type="file" id="fileUpload" class="sr-only" accept="image/*" multiple>
          </div>
          <textarea class="few" id="inputMsg" placeholder="메시지를 입력하세요"></textarea>
          <button class="send" id="btnSend" type="button">보내기</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Lightbox Viewer -->
  <aside class="viewer" id="viewer" aria-hidden="true" aria-label="이미지 뷰어">
    <div class="stage"><img id="viewerImg" alt="원본 이미지" /></div>
    <div class="ctrl">
      <button type="button" id="btnFit">100%</button>
      <button type="button" id="btnClose">닫기</button>
    </div>
    <button type="button" class="arrow prev" id="btnPrev" aria-label="이전">‹</button>
    <button type="button" class="arrow next" id="btnNext" aria-label="다음">›</button>
  </aside>
</main>

<div class="include" th:replace="~{include/footer :: footer}"></div>
<script th:src="@{/js/js.js}"></script>
<script th:src="@{/js/gChating.js}"></script>

<!-- ================== 메시지 한 줄 템플릿 ================== -->
<th:block th:fragment="messageRow (msg, loginMember)">
  <!-- 내가 보낸 건 오른쪽, 변호사가 보낸 건 왼쪽 -->
  <div th:class="'msg-row ' + (${msg.senderType} == 'MEMBER' ? 'user' : 'lawyer')">
    <!-- 내가 보낸 경우 시간 먼저 -->
    <div th:if="${msg.senderType} == 'MEMBER'" class="meta"
         th:text="${#temporals.format(msg.chatRegDate, 'HH:mm')}">오후 1:41</div>

    <!-- 텍스트 버블 -->
    <div th:if="${msg.chatContent != null}" class="bubble">
      <div th:text="${msg.chatContent}">내용</div>
    </div>

    <!-- 상대가 보낸 경우 시간은 뒤에 -->
    <div th:if="${msg.senderType} != 'MEMBER'" class="meta"
         th:text="${#temporals.format(msg.chatRegDate, 'HH:mm')}">오후 1:41</div>

    <!-- 첨부가 있을 때 -->
    <div th:if="${msg.attachments != null and #lists.size(msg.attachments) > 0}" class="media">
      <a th:each="att : ${msg.attachments}"
         th:href="@{'/chat/attachment/' + ${att.attachmentId}}"
         target="_blank">
        <img th:src="@{'/chat/attachment/' + ${att.attachmentId}}"
             th:alt="${att.fileName} ?: '첨부'" />
      </a>
    </div>
  </div>
</th:block>

</body>
</html>
