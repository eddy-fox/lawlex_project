<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>채팅 (일반회원)</title>
  <link rel="stylesheet" th:href="@{/css/gChating.css}">
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script>
    // Stomp 라이브러리 로드 확인
    window.addEventListener('load', function() {
      if (typeof Stomp === 'undefined') {
        console.error('[DEBUG] Stomp library failed to load');
      } else {
        console.log('[DEBUG] Stomp library loaded successfully');
      }
    });
  </script>
</head>
<body>
<main class="page-gChating">
  <div class="container">
    <div class="room">

      <!-- ===== 상단 헤더 ===== -->
      <header class="head">
        <div class="pic">
          <!-- 변호사 프로필 사진 / 없으면 이니셜 -->
          <img th:if="${lawyer != null and lawyer.lawyerImgPath != null}"
               th:src="${lawyer.lawyerImgPath}"
               alt="프로필" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">
          <span th:if="${lawyer == null or lawyer.lawyerImgPath == null}"
                th:text="${lawyer != null ? lawyer.lawyerName : 'LAW'}">
            LAW
          </span>
        </div>

        <div class="info">
          <div class="name"
               th:text="${lawyer != null ? lawyer.lawyerName + ' 변호사' : '변호사 채팅'}">
            변호사 이름
          </div>
          <div class="timewin" th:if="${room != null}">
            상담 신청 시간
            <span th:text="${#temporals.format(room.requestedAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 12:00</span>
            <span th:if="${room.durationMinutes != null}">
              &nbsp;(~ 약 <span th:text="${room.durationMinutes}">60</span>분)
            </span>
          </div>
          <div th:if="${lawyer != null and lawyer.lawyerComment != null}" 
               style="font-size: 12px; color: #64748b; margin-top: 4px;"
               th:text="${lawyer.lawyerComment}">
            변호사 소개
          </div>
        </div>

        <div class="badges">
          <!-- 남은 시간 -->
          <span id="remainTime"
                class="remain"
                th:if="${room != null and room.expiresAt != null}"
                th:attr="data-expires-at=${#temporals.format(room.expiresAt,'yyyy-MM-dd''T''HH:mm:ss')}">
            남은시간 00:00
          </span>
        </div>
      </header>

      <!-- ===== 메시지 영역 ===== -->
      <div id="msgs" class="msgs">
        <!-- 날짜 칩 / 필요하면 요일별로 group 해서 붙여도 됨 -->

        <!-- 첫 번째 메시지가 마지막 읽은 메시지 이후인 경우 마커 표시 -->
        <div th:if="${lastReadChatIdx != null and !#lists.isEmpty(initBatch) and initBatch[0].chatIdx > lastReadChatIdx}"
             class="read-marker"
             style="width: 100%; text-align: center; padding: 8px 0; color: #64748b; font-size: 12px; border-top: 1px solid #e5e7eb; margin-bottom: 8px;">
          ---여기까지 읽었습니다---
        </div>

        <!-- 초기 메시지 배치 렌더 -->
        <div th:each="m, iterStat : ${initBatch}"
             th:class="'msg-row ' + (${m.senderType} == 'MEMBER' ? 'user' : 'lawyer')">

          <!-- 마지막 읽은 메시지 이후 마커 표시 (메시지 앞에) -->
          <div th:if="${lastReadChatIdx != null and iterStat.index > 0 and initBatch[iterStat.index - 1].chatIdx == lastReadChatIdx}"
               class="read-marker"
               style="width: 100%; text-align: center; padding: 8px 0; color: #64748b; font-size: 12px; border-top: 1px solid #e5e7eb; margin-bottom: 8px;">
            ---여기까지 읽었습니다---
          </div>

          <!-- 내가 보낸 메시지(MEMBER) → 오른쪽, 시간 먼저 -->
          <div th:if="${m.senderType == 'MEMBER'}" class="meta"
               th:text="${#temporals.format(m.chatRegDate,'HH:mm')}">12:34</div>

          <div th:if="${m.chatContent != null}" class="bubble">
            <div th:text="${m.chatContent}">메시지 내용</div>
          </div>

          <!-- 상대(변호사)가 보낸 메시지 → 왼쪽, 말풍선 뒤에 시간 -->
          <div th:if="${m.senderType != 'MEMBER'}" class="meta"
               th:text="${#temporals.format(m.chatRegDate,'HH:mm')}">12:34</div>

          <!-- 첨부 이미지가 있을 때 -->
          <div th:if="${m.attachments != null and !m.attachments.isEmpty()}"
               class="media">
            <a th:each="att : ${m.attachments}"
               th:href="@{'/chat/attachment/' + ${att.attachmentId}}"
               target="_blank">
              <img th:src="@{'/chat/attachment/' + ${att.attachmentId}}"
                   th:alt="${att.fileName != null ? att.fileName : '첨부파일'}">
            </a>
          </div>
        </div>
      </div>

      <!-- ===== 입력 영역 (로그인된 회원만) ===== -->
      <div class="dock" th:if="${meMemberIdx != null}">
        <!-- 이미지 미리보기 -->
        <div id="previews" class="previews"></div>

        <div class="inputbar">
          <div class="toolbar">
            <button type="button" id="btnUpload" class="icon-btn" aria-label="이미지 첨부">
              +
            </button>
            <input type="file" id="fileUpload" accept="image/*" multiple hidden>
          </div>

          <textarea id="inputMsg" class="few"
                    placeholder="메시지를 입력하세요"
                    autocomplete="off"></textarea>

          <button id="btnSend" type="button" class="send">전송</button>
        </div>
      </div>

      <!-- 비로그인/세션 만료 시 -->
      <div class="dock" th:if="${meMemberIdx == null}">
        <div class="inputbar">
          <textarea class="few" disabled>로그인이 필요합니다.</textarea>
          <button class="send" type="button" disabled>전송</button>
        </div>
      </div>

      <!-- ===== 숨겨진 값들: JS에서 사용 ===== -->
      <input type="hidden" id="roomId"
             th:value="${room != null ? room.chatroomIdx : 0}">
      <input type="hidden" id="senderType" value="MEMBER">
      <input type="hidden" id="senderId"
             th:value="${meMemberIdx != null ? meMemberIdx : 0}">
      <input type="hidden" id="expiresAt"
             th:if="${room != null and room.expiresAt != null}"
             th:value="${#temporals.format(room.expiresAt,'yyyy-MM-dd''T''HH:mm:ss')}">
    </div>

    <!-- ===== 라이트박스 (이미지 클릭 확대) ===== -->
    <div id="viewer" class="viewer" aria-hidden="true">
      <div class="stage">
        <img id="viewerImg" src="" alt="확대 이미지">
      </div>
      <div class="ctrl">
        <button type="button" id="btnFit">100%</button>
        <button type="button" id="btnClose">닫기</button>
      </div>
      <button type="button" id="btnPrev" class="arrow prev">&#10094;</button>
      <button type="button" id="btnNext" class="arrow next">&#10095;</button>
    </div>
  </div>
</main>

<!-- 전역 JS (chatIcon, sideMenu, gChating/lChating 스크립트 포함) -->
<script th:src="@{/js/js.js}"></script>
<script th:src="@{/js/chatIcon.js}"></script>
<script th:src="@{/js/gChating.js}"></script>
</body>
</html>
