<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>상담글 상세</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/reBoard.css}">
</head>
<body>
  <div class="include" th:replace="~{include/header :: header}"></div>
  <main class="page-reBoard">
    <div class="sideMenu" th:replace="~{include/bSide :: bSide}"></div>
    <div class="wrap">
      <div class="backdrop">
       
          <div class="inner">
            <h1 class="post-title" th:text="${boardEntity.boardTitle}"></h1>
            <div class="post-meta" th:text="${#temporals.format(boardEntity.boardRegDate, 'yyyy-MM-dd')}"></div>
            <div class="card-text" th:text="${boardEntity.boardContent}"></div>

            <div class="edit">
              <a class="link" th:href="@{|/board/modify/${boardEntity.boardIdx}|}"
              sec:authorize="isAuthenticated()" 
              th:if="${(boardEntity.member != null and #authentication != null and #authentication.principal != null and #authentication.principal.memberIdx != null and #authentication.principal.memberIdx == boardEntity.member.memberIdx) or (isAdmin != null and isAdmin)}" 
              th:text="수정"></a>
              <a class="link delete" href="javascript:void(0);" th:data-uri="@{|/board/delete/${boardEntity.boardIdx}|}"
              sec:authorize="isAuthenticated()" 
              th:if="${(boardEntity.member != null and #authentication != null and #authentication.principal != null and #authentication.principal.memberIdx != null and #authentication.principal.memberIdx == boardEntity.member.memberIdx) or (isAdmin != null and isAdmin)}" 
              th:text="삭제"></a>
            </div>

            <!-- 답변 목록 섹션 -->
            <div class="answers-section">
              <div class="answers-header">
                <div class="answers-header-left">
                  <span class="answers-count" th:text="${boardEntity.reboardList != null ? (#lists.size(boardEntity.reboardList) + '개 답변') : '0개 답변'}"></span>
                  <button type="button" class="btn-answer-toggle" id="answerToggleBtn"
                          sec:authorize="isAuthenticated()" 
                          th:if="${loginUser != null and loginUser.role == 'LAWYER' and loginUser.lawyerIdx != null}">
                    답변 달기
                  </button>
                </div>
                <div class="answers-sort">
                  <select class="sort-select">
                    <option>최적</option>
                    <option>추천순</option>
                  </select>
                </div>
              </div>

              <!-- 답변 작성 폼 (토글) -->
              <div class="answer-form-wrapper" id="answerFormWrapper" style="display: none;"
                   sec:authorize="isAuthenticated()" 
                   th:if="${loginUser != null and loginUser.role == 'LAWYER' and loginUser.lawyerIdx != null}">
                <div class="answer-avatar">
                  <img th:if="${loginLawyer != null and loginLawyer.lawyerImgPath != null and loginLawyer.lawyerImgPath != ''}" 
                       th:src="${loginLawyer.lawyerImgPath}" 
                       alt="변호사 프로필"
                       class="lawyer-profile-img-small">
                  <span th:if="${loginLawyer == null or loginLawyer.lawyerImgPath == null or loginLawyer.lawyerImgPath == ''}">A</span>
                </div>
                <form th:action="@{|/reboard/create/${boardEntity.boardIdx}|}" th:object="${reBoardForm}" method="post" class="answer-form">
                  <textarea th:field="*{reboardContent}" 
                  class="answer-textarea" 
                  placeholder="답변자님, 정보를 공유해 주세요." 
                  rows="4"></textarea>
                  <div class="answer-form-actions">
                    <button type="submit" class="btn-answer-submit">답변</button>
                    <button type="button" class="btn-answer-cancel" id="answerCancelBtn">취소</button>
                  </div>
                </form>
              </div>

              <!-- 답변 리스트 (로그인 필요) -->
              <div class="answers-list-wrapper" th:classappend="${loginUser == null ? 'login-required' : ''}">
                <!-- 비로그인 오버레이 -->
                <div class="answers-overlay" sec:authorize="isAnonymous()">
                  <div class="overlay-content">
                    <p class="overlay-message">로그인 후에 답변 확인이 가능합니다</p>
                    <a th:href="@{/member/login}" class="overlay-login-btn">로그인하기</a>
                  </div>
                </div>
                
                <!-- 답변 리스트 -->
                <div class="answers-list" th:if="${boardEntity.reboardList != null and !#lists.isEmpty(boardEntity.reboardList)}">
                <div class="answer-item" th:each="reboard : ${boardEntity.reboardList}">
                  <div class="answer-avatar-large">
                    <img th:if="${(reboard.lawyer != null and reboard.lawyer.lawyerImgPath != null and reboard.lawyer.lawyerImgPath != '') or (reboard.lawyerIdx != null and reboard.lawyerIdx.lawyerImgPath != null and reboard.lawyerIdx.lawyerImgPath != '')}" 
                         th:src="${reboard.lawyer != null ? reboard.lawyer.lawyerImgPath : (reboard.lawyerIdx != null ? reboard.lawyerIdx.lawyerImgPath : '')}" 
                         alt="변호사 프로필"
                         class="lawyer-profile-img">
                    <span th:if="${(reboard.lawyer == null or reboard.lawyer.lawyerImgPath == null or reboard.lawyer.lawyerImgPath == '') and (reboard.lawyerIdx == null or reboard.lawyerIdx.lawyerImgPath == null or reboard.lawyerIdx.lawyerImgPath == '')}">A</span>
                  </div>
                  <div class="answer-content-wrapper">
                    <div class="answer-header">
                      <div class="answer-author">
                        <!-- GPT 답변인 경우: 변호사 붙이지 않음 -->
                        <span class="answer-author-name" 
                              th:if="${reboard.lawyer != null and reboard.lawyer.lawyerIdx == 205}"
                              th:text="${reboard.lawyer.lawyerName != null ? reboard.lawyer.lawyerName : 'AI 법률상담'}"></span>
                        
                        <!-- 일반 변호사 답변인 경우: 변호사 붙임 -->
                        <span class="answer-author-name" 
                              th:if="${reboard.lawyer == null or reboard.lawyer.lawyerIdx != 205}"
                              th:text="${reboard.lawyer != null and reboard.lawyer.lawyerName != null ? (reboard.lawyer.lawyerName + ' 변호사') : '익명'}"></span>
                        <span class="answer-date" th:if="${reboard.reboardRegDate != null}" th:text="${#temporals.format(reboard.reboardRegDate, 'yyyy-MM-dd')}"></span>
                      </div>
                    </div>
                    <!-- GPT 답변 경고 문구 -->
                    <div class="gpt-disclaimer" 
                        th:if="${reboard.lawyer != null and reboard.lawyer.lawyerIdx == 205}">
                      <strong>이 답변은 AI가 생성한 참고용 정보이며 법률적 정확성이 보장되지 않습니다. 실제 행동이나 의사결정에 활용하기 전에 반드시 전문가의 확인을 받으시기 바랍니다.</strong>
                    </div>
                    <div class="answer-content" th:text="${reboard.reboardContent}"></div>
                    <div class="answer-actions">
                      <!-- 일반 변호사 답변만 추천 버튼 표시 -->
                      <a href="javascript:void(0);" 
                        class="recommend-link" 
                        th:if="${reboard.lawyer == null or reboard.lawyer.lawyerIdx != 205}"
                        th:data-uri="@{|/reboard/vote/${reboard.reboardIdx}|}">
                        도움됐어요
                        <span class="recommend-count" th:text="${#lists.size(reboard.voter)}"></span>
                      </a>
                      <a th:href="@{|/reboard/modify/${reboard.reboardIdx}|}" 
                         class="answer-reply-btn"
                         sec:authorize="isAuthenticated()" 
                         th:if="${reboard.lawyer != null and #authentication != null and #authentication.principal != null and #authentication.principal.lawyerName != null and #authentication.principal.lawyerName == reboard.lawyer.lawyerName}">
                        수정
                      </a>
                    </div>
                  </div>
                </div>
                </div>
              </div>
            </div>
              <!-- <article class="cmt">
                <div class="cmt-head">
                  <div class="cmt-avatar"><img src="https://via.placeholder.com/72x96" alt="프로필"></div>
                  <div class="chip">김현중 변호사</div>
                  <div class="chip">2025-09-29 21:14</div>
                  <div class="chip">😊 도움됐어요 <strong>2</strong></div>
                </div>
                <div class="cmt-body">
                    소액의 벌금 정도로 마무리 가능성이 높습니다.
                    유사 사건 다수 처리 경험이 있습니다.
                    상담 답변은 사무장이 아닌 변호사가 직접 작성합니다.
                </div>
              </article> -->


            <!-- <div class="note" id="replyBox">
              <div class="note-header">
                <span class="badge" id="statusText" th:if="${ReBoard}">변호사님의 답변을 기다리고 있어요.
                  <button id="open" class="btn">답변하기</button>
                </span>
              </div>
              <div id="replyArea" class="hidden">
                <textarea id="ta" class="textarea" placeholder="1. ~&#10;2. ~&#10;3. ~ 처럼 줄바꿈으로 항목을 쓰면 목록으로 들어갑니다." minlength="10"></textarea>
                <div class="counter"><span id="count">0</span> / <span id="min">10</span>자 <span id="ok" class="ok hidden">가능</span></div>
                <div class="actions">
                  <button id="submit" class="btn" disabled>등록</button>
                  <button id="cancel" class="btn ghost">취소</button>
                </div>
              </div>
            </div> -->

            <div id="comments"></div>

          </div>
   
      </div>
    </div>
  </main>
    <div class="include" th:replace="~{include/footer :: footer}"></div>
  <script th:src="@{/js/reBoard.js}"></script>   
</body>
</html>