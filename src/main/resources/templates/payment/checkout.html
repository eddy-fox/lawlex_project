<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="https://static.toss.im/icons/png/4x/icon-toss-logo.png" />
    <link rel="stylesheet" type="text/css" href="toss.css" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>토스페이먼츠 샘플 프로젝트</title>
    <!-- 토스페이먼츠 SDK 추가 -->
    <script src="https://js.tosspayments.com/v2/standard"></script>
  </head>

  <body>
    <!-- 주문서 영역 -->
    <div class="wrapper">
      <div class="box_section" style="padding: 40px 30px 50px 30px; margin-top: 30px; margin-bottom: 50px">
        <!-- 결제하기 버튼 -->
        <div class="result wrapper">
          <button class="button" id="payment-button" style="margin-top: 30px">
            결제하기
          </button>
        </div>
      </div>
    </div>
    
    <script th:inline="javascript">
      // 금액에서 쉼표 제거하고 숫자로 변환
      const amount = parseInt("[[${product.productPrice}]]".replace(/,/g, ''));
      
      // 전화번호에서 특수문자 제거 (숫자만)
      function formatPhoneNumber(phone) {
        return phone ? phone.replace(/[^0-9]/g, '') : '';
      }
      
      // ------  SDK 초기화 ------
      const clientKey = "test_ck_oEjb0gm23P5GeZ2laN2WVpGwBJn5";
      const customerKey = generateRandomString();
      const tossPayments = TossPayments(clientKey);
      const payment = tossPayments.payment({ customerKey });

      // ------ '결제하기' 버튼 누르면 결제창 띄우기 ------
      document.getElementById("payment-button").addEventListener("click", async function () {
        await payment.requestPayment({
          method: "CARD",
          amount: {
            currency: "KRW",
            value: amount
          },
          orderId: "[[${purchase.purchaseId}]]",
          orderName: "[[${product.productContent}]]",
          // ✅ /payment/ 유지
          successUrl: window.location.origin + "/payment/success",
          failUrl: window.location.origin + "/payment/fail",
          customerEmail: "[[${member.memberEmail}]]", 
          customerName: "[[${member.memberName}]]",
          customerMobilePhone: formatPhoneNumber("[[${member.memberPhone}]]"),
          card: {
            useEscrow: false,
            flowMode: "DEFAULT",
            useCardPoint: false,
            useAppCardOnly: false,
          }
        });
      });

      function generateRandomString() {
        return window.btoa(Math.random()).slice(0, 20);
      }
    </script>
  </body>
</html>