<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LawLex홈페이지</title>
  <link th:href="@{/css/style.css}" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/css/index.css}">
</head>

<body>
  <div class="include" th:replace="~{include/header :: header}"></div>
  <main class="page-index">
    <section class="hero">
      <div class="inner">

        <button class="nav-btn nav-prev" onclick="prevSlide()">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M12 4L6 10L12 16" stroke="#000777" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </button>

        <!-- <div class="content" th:each="ad : ${adList}">
            <a th:href="@{/}"
          </div> -->

        <button class="nav-btn nav-next" onclick="nextSlide()">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M8 4L14 10L8 16" stroke="#000777" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </button>

        <div class="content" th:each="ad, iterStat : ${adList}" th:id="'slide-' + ${iterStat.index}"
          th:classappend="${iterStat.index == 0} ? ' active' : ''">
          <a class="aLink" href="#" th:onclick="|adCount(${ad.adIdx})|">
            <img th:src="${ad.adImgPath}" th:alt="${ad.adName}">
          </a>
        </div>

        <button class="nav-btn nav-next" onclick="nextSlide()">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M8 4L14 10L8 16" stroke="#000777" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </button>
      </div>
    </section>

    <section>
      <div class="wrap">
        <h2 class="section-ttl" th:with="user=${session.loginUser}">
          <span th:if="${user == null}">현재 인기 많은 글</span>
          <span th:if="${user != null}">내 관심 카테고리 인기글</span>
        </h2>
        <div class="list-card">
          <table class="tbl">
            <thead>
              <tr>
                <th>#</th>
                <th>분야</th>
                <th>제목</th>
                <th>조회</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="board, iterStat : ${topBoards}">
                <td th:text="${iterStat.count}"></td>
                <td><span class="badge" th:text="${board.interest != null ? board.interest.interestName : '기타'}"></span>
                </td>
                <td class="cell-title">
                  <a class="aLink" th:href="@{/board/detail/{id}(id=${board.boardIdx})}"
                    th:text="${board.boardTitle}"></a>
                </td>
                <td th:text="${#numbers.formatDecimal(board.boardViews, 0, 'COMMA', 0, 'POINT')}"></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section>
      <div class="wrap">
        <h2 class="section-ttl">지금 바로 상담 가능한 변호사</h2>
        <div class="group">
          <div class="card" th:each="lawyer : ${availableLawyers}">
            <div class="lImg">
              <img th:if="${lawyer.imgPath != null}" th:src="${lawyer.imgPath}" alt="변호사 사진">
              <img th:if="${lawyer.imgPath == null}" th:src="@{/img/test.png}" alt="">
            </div>
            <div class="name">
              <b th:if="${lawyer.address != null}">
                <span th:with="region=${#strings.contains(lawyer.address, ' ') ? #strings.substring(lawyer.address, 0, #strings.indexOf(lawyer.address, ' ')) : lawyer.address}">
                  <span th:if="${region == '서울특별시'}">서울</span>
                  <span th:if="${region == '부산광역시'}">부산</span>
                  <span th:if="${region == '대구광역시'}">대구</span>
                  <span th:if="${region == '인천광역시'}">인천</span>
                  <span th:if="${region == '광주광역시'}">광주</span>
                  <span th:if="${region == '대전광역시'}">대전</span>
                  <span th:if="${region == '울산광역시'}">울산</span>
                  <span th:if="${region == '세종특별자치시'}">세종</span>
                  <span th:if="${region == '경기도'}">경기</span>
                  <span th:if="${region == '강원특별자치도'}">강원</span>
                  <span th:if="${region == '충청북도'}">충북</span>
                  <span th:if="${region == '충청남도'}">충남</span>
                  <span th:if="${region == '전라북도'}">전북</span>
                  <span th:if="${region == '전라남도'}">전남</span>
                  <span th:if="${region == '경상북도'}">경북</span>
                  <span th:if="${region == '경상남도'}">경남</span>
                  <span th:if="${region == '제주특별자치도'}">제주</span>
                  <span th:if="${region != '서울특별시' and region != '부산광역시' and region != '대구광역시' and region != '인천광역시' and region != '광주광역시' and region != '대전광역시' and region != '울산광역시' and region != '세종특별자치시' and region != '경기도' and region != '강원특별자치도' and region != '충청북도' and region != '충청남도' and region != '전라북도' and region != '전라남도' and region != '경상북도' and region != '경상남도' and region != '제주특별자치도'}" 
                        th:text="${region}">지역</span>
                </span>
              </b>
              <b th:if="${lawyer.address == null}">지역</b>
              <b>|</b>
              <b th:text="|${lawyer.name} 변호사|">변호사명</b>
            </div>
            <div class="interest" th:text="${lawyer.interestName != null ? lawyer.interestName : '분야'}">분야</div>
            <form th:action="@{/chat/request}" method="post">
              <input type="hidden" name="lawyerIdx" th:value="${lawyer.lawyerIdx}">
              <div class="time">
                <label>
                  <input type="radio" name="durationMinutes" value="30"
                         th:disabled="${lawyer.can30 == null or !lawyer.can30}"
                         th:checked="${lawyer.can30 != null and lawyer.can30}">
                  30분
                </label>
                <label>
                  <input type="radio" name="durationMinutes" value="60"
                         th:disabled="${lawyer.can60 == null or !lawyer.can60}"
                         th:checked="${(lawyer.can60 != null and lawyer.can60) and (lawyer.can30 == null or !lawyer.can30)}">
                  60분
                </label>
              </div>
              <button type="submit" class="cardBtn"
                      th:disabled="${lawyer.canRequestNow == null or !lawyer.canRequestNow}">신청하기</button>
              <input type="hidden" th:if="${_csrf != null}"
                     th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            </form>
          </div>
          <p class="empty" th:if="${#lists.isEmpty(availableLawyers)}" style="text-align: center; padding: 20px;">
            지금 상담 가능한 변호사가 없습니다.
          </p>
        </div>

      </div>
    </section>

    <section class="lawyer-wrap">
      <div class="wrap">
        <h2 class="section-ttl">알아두면 좋을 법률정보</h2>
        <div class="legal-grid">

          <!-- 조회수 높은 동영상 2개 -->
          <div class="legal-card" th:each="video, iterStat : ${topVideos}">
            <div class="legal-img">
              <img th:if="${video.videoId != null}"
                th:src="'https://img.youtube.com/vi/' + ${video.videoId} + '/hqdefault.jpg'" alt="video thumbnail"
                style="width:100%;height:100%;object-fit:cover;display:block;">
              <img th:if="${video.videoId == null and video.newsImgPath != null}" th:src="${video.newsImgPath}"
                alt="video image" style="width:100%;height:100%;object-fit:cover;display:block;">
              <div th:if="${video.videoId == null and video.newsImgPath == null}"
                style="width:100%;height:100%;background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999;">
                이미지 없음</div>
              <div class="legal-badge">HOT</div>
            </div>
            <div class="legal-body">
              <h3 class="legal-ttl">
                <a class="aLink" th:href="@{/newsBoard/detail(newsIdx=${video.newsIdx})}"
                  th:text="${video.newsTitle}"></a>
              </h3>
              <div class="legal-meta">
                <svg class="legal-ic" viewBox="0 0 14 14" fill="none">
                  <circle cx="7" cy="7" r="6" stroke="#999" stroke-width="1.5" fill="none" />
                  <path d="M7 3V7L10 9" stroke="#999" stroke-width="1.5" />
                </svg>
                <span th:text="${#temporals.format(video.newsRegDate, 'yyyy.MM')}"></span>
              </div>
            </div>
          </div>

          <!-- 최신 동영상 1개 -->
          <div class="legal-card" th:if="${latestVideo != null && !latestVideo.isEmpty()}"
            th:each="video : ${latestVideo}">
            <div class="legal-img">
              <img th:if="${video.videoId != null}"
                th:src="'https://img.youtube.com/vi/' + ${video.videoId} + '/hqdefault.jpg'" alt="video thumbnail"
                style="width:100%;height:100%;object-fit:cover;display:block;">
              <img th:if="${video.videoId == null and video.newsImgPath != null}" th:src="${video.newsImgPath}"
                alt="video image" style="width:100%;height:100%;object-fit:cover;display:block;">
              <div th:if="${video.videoId == null and video.newsImgPath == null}"
                style="width:100%;height:100%;background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999;">
                이미지 없음</div>
              <div class="legal-badge new">NEW</div>
            </div>
            <div class="legal-body">
              <h3 class="legal-ttl">
                <a th:href="@{/newsBoard/detail(newsIdx=${video.newsIdx})}" th:text="${video.newsTitle}"></a>
              </h3>
              <div class="legal-meta">
                <svg class="legal-ic" viewBox="0 0 14 14" fill="none">
                  <circle cx="7" cy="7" r="6" stroke="#999" stroke-width="1.5" fill="none" />
                  <path d="M7 3V7L10 9" stroke="#999" stroke-width="1.5" />
                </svg>
                <span th:text="${#temporals.format(video.newsRegDate, 'yyyy.MM')}"></span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <section>
      <div class="wrap">
        <div class="news-head">
          <div class="news-left">
            <div class="news-tabs">
              <span class="tab active" data-tab="popular">실시간 인기 뉴스</span>
              <span class="tab-sep">|</span>
              <span class="tab" data-tab="latest">최신뉴스</span>
            </div>
          </div>
        </div>

        <div class="news-list" id="news-popular">
          <div class="news-item" th:each="news, iterStat : ${popularNews}">
            <div class="rank" th:text="${iterStat.count}"></div>
            <div class="text">
              <a class="aLink" th:href="@{/newsBoard/detail(newsIdx=${news.newsIdx})}" th:text="${news.newsTitle}"></a>
            </div>
          </div>
        </div>

        <div class="news-list" id="news-latest" style="display: none;">
          <div class="news-item" th:each="news, iterStat : ${latestNews}">
            <div class="rank" th:text="${iterStat.count}"></div>
            <div class="text">
              <a class="aLink" th:href="@{/newsBoard/detail(newsIdx=${news.newsIdx})}" th:text="${news.newsTitle}"></a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
  <div class="include" th:replace="~{include/footer :: footer}"></div>

  <script>
    // 광고 슬라이드
    let currentSlide = 0;
    const slides = document.querySelectorAll('.content');
    const totalSlides = slides.length;

    function showSlide(index) {
      if (totalSlides === 0) return; // 광고가 없으면 실행하지 않음
      slides.forEach((slide, i) => {
        if (i === index) {
          slide.classList.add('active');
        } else {
          slide.classList.remove('active');
        }
      });
    }

    function nextSlide() {
      if (totalSlides === 0) return; // 광고가 없으면 실행하지 않음
      currentSlide = (currentSlide + 1) % totalSlides;
      showSlide(currentSlide);
    }
    function prevSlide() {
      if (totalSlides === 0) return; // 광고가 없으면 실행하지 않음
      currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
      showSlide(currentSlide);
    }

    if (totalSlides > 0) {
      setInterval(nextSlide, 10000);
      document.addEventListener("DOMContentLoaded", () => showSlide(0));
    }

    // 변호사 페이지 이동 + 조회수 증가
    function adCount(adIdx, lawyerIdx) {
      fetch('/admin/adCount', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ adIdx: adIdx })
      })
        .then(response => {
          if (response.ok) {
            // DB에서 adViews 증가 성공 시 변호사 페이지로 이동
            window.location.href = `/lawyer/myPage?lawyerIdx=${lawyerIdx}`;
          } else {
            console.error('조회수 증가 실패');
          }
        })
        .catch(err => console.error('에러 발생:', err));
    }

    // 뉴스 탭 전환 (인라인 스크립트로 직접 처리)
    document.addEventListener('DOMContentLoaded', function () {
      console.log('탭 전환 스크립트 로드됨');

      const tabs = document.querySelectorAll('.news-tabs .tab');
      const popularNews = document.getElementById('news-popular');
      const latestNews = document.getElementById('news-latest');

      console.log('탭 개수:', tabs.length);
      console.log('인기 뉴스 요소:', popularNews);
      console.log('최신 뉴스 요소:', latestNews);

      if (tabs.length > 0 && popularNews && latestNews) {
        tabs.forEach(function (tab, index) {
          console.log('탭 ' + index + '에 이벤트 리스너 추가:', tab.getAttribute('data-tab'));

          tab.addEventListener('click', function (e) {
            console.log('탭 클릭됨:', this.getAttribute('data-tab'));
            e.preventDefault();
            e.stopPropagation();

            const tabName = this.getAttribute('data-tab');
            if (!tabName) {
              console.log('탭 이름이 없음');
              return;
            }

            // 모든 탭에서 active 클래스 제거
            tabs.forEach(function (el) {
              el.classList.remove('active');
            });

            // 클릭한 탭에 active 클래스 추가
            this.classList.add('active');
            console.log('active 클래스 추가됨');

            // 뉴스 리스트 표시/숨김
            if (tabName === 'popular') {
              popularNews.style.display = 'block';
              latestNews.style.display = 'none';
              console.log('인기 뉴스 표시');
            } else if (tabName === 'latest') {
              popularNews.style.display = 'none';
              latestNews.style.display = 'block';
              console.log('최신 뉴스 표시');
            }
          });
        });
      } else {
        console.error('탭 또는 뉴스 요소를 찾을 수 없음');
        console.log('탭:', tabs);
        console.log('인기 뉴스:', popularNews);
        console.log('최신 뉴스:', latestNews);
      }
    });
  </script>

<!-- ✅ 추가: 마이페이지 버튼 강제 이동 (다른 코드에 영향 없음) -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var btn = document.getElementById('btnMypage');
    if (!btn) return;
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      var url = btn.getAttribute('data-url') || '/member/mypage';
      window.location.assign(url); // 절대경로로 확실히 이동
    }, { capture: true });
  });
</script>

    <script th:src="@{/js/js.js}"></script>
    <script th:src="@{/js/chatIcon.js}"></script>
    <script th:src="@{/js/index.js}"></script>
</body>
</html>
