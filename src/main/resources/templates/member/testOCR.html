<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OCRí…ŒìŠ¤íŠ¸</title>
</head>
<body>
    <form th:action="@{/member/testOCR}" method="post" th:object="${lawyerAuth}" enctype="multipart/form-data">
        <div>
            <div>ìê²©ë²ˆí˜¸: </div>
            <input type="text" th:field="*{lawyerAuth}" id="authNum"> <br>

            <div>ì´ë¯¸ì§€ íŒŒì¼</div>
            <input type="text" id="imgUrl" readonly placeholder="ì„ íƒëœ íŒŒì¼ëª…"/>
            <button type="button" id="findImgBtn">ì°¾ì•„ë³´ê¸°</button> <br>
            <div>ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</div> <br>
            <input id="adImageFile" type="file" accept="image/*" style="display:none">
            <img id="previewImg" alt="ë¯¸ë¦¬ë³´ê¸°"> <br>

            <button type="button" id="verifyBtn">ì¸ì¦</button>
        </div>
        <button type="submit" id="submitBtn">ì œì¶œ</button>
    </form>
</body>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("findImgBtn");
        const fileInput = document.getElementById("adImageFile");
        const imgUrlInput = document.getElementById("imgUrl"); 
        const preview = document.getElementById("previewImg");

        btn.addEventListener("click", () => fileInput.click());

        fileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;

            imgUrlInput.value = file.name;

            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ 
            const reader = new FileReader();
            reader.onload = (ev) => {
            preview.src = ev.target.result;
            preview.style.display = "block";
            };
            reader.readAsDataURL(file);

        });
    });

    document.getElementById("verifyBtn").addEventListener("click", async () => {
        const number = document.getElementById("authNum").value;
        const image = document.getElementById("adImageFile").files[0];

        const formData = new FormData();
        formData.append("licenseNumber", number);
        formData.append("licenseImage", image);

        const res = await fetch("/member/verify-license", {
            method: "POST",
            body: formData
        });

        const result = await res.json();

        console.log("ğŸ” OCR ê²°ê³¼:", result.ocrTexts);

        if (result.valid === true) {
            alert((result.message || "ìê²© ê²€ì¦ ì„±ê³µ") + "\n\nğŸ“„ OCR ì¸ì‹ ê²°ê³¼:\n" + (result.ocrTexts || []).join("\n"));
            document.getElementById("submitBtn").disabled = false;
        } else {
            alert((result.error || result.message || "ìê²© ê²€ì¦ ì‹¤íŒ¨. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.") 
                + "\n\nğŸ“„ OCR ì¸ì‹ ê²°ê³¼:\n" + (result.ocrTexts || []).join("\n"));
            document.getElementById("submitBtn").disabled = true;
        }
    });
</script>
</html>