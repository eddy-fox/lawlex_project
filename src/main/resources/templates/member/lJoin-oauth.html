<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë³€í˜¸ì‚¬íšŒì›ê°€ì…</title>
  <link rel="stylesheet" th:href="@{/css/lJoin.css}">
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
  <div class="include" th:replace="~{include/header :: header}"></div>

  <main class="page-lJoin">
    <section class="center-card">
      <div class="head">
        <h1 class="title">ë³€í˜¸ì‚¬ íšŒì›ê°€ì…</h1>
      </div>

      <!-- ë³€í˜¸ì‚¬ íšŒì›ê°€ì… í¼ -->
      <form id="lawyerJoinForm" class="form"
            th:action="@{/member/joinLawyer-oauth}"
            method="post"
            enctype="multipart/form-data"
            th:object="${joinLawyer}"
            novalidate>

        <!-- CSRF -->
        <th:block th:if="${_csrf != null}">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        </th:block>

        <!-- 3. ì´ë¦„ (ì•„ì´ë”” ì•„ë˜ë¡œ ë‚´ë¦¼) -->
        <div class="field">
          <input id="lawyerName"
                 name="lawyerName"
                 class="input"
                 type="text"
                 th:value="${joinLawyer.lawyerName}"
                 readonly>
        </div>

        <!-- 4. ë“±ë¡ë²ˆí˜¸ (ì´ë¦„ ì•„ë˜ë¡œ ë‚´ë¦¼) -->
        <div class="field">
          <input id="lawyerAuth"
                 name="lawyerAuth"
                 class="input"
                 type="text"
                 th:field="*{lawyerAuth}"
                 placeholder="ë“±ë¡ë²ˆí˜¸"
                 inputmode="numeric"
                 required>
        </div>
        <div class="field">
          <div class="agree-area">
            <div class="left">
              <!-- ì‹ ë¶„ì¦ ì—…ë¡œë“œ ì œê±°, ë“±ë¡ì¦ë§Œ ìœ ì§€ -->
              <input id="certImage"
                    name="certImage"
                    type="file"
                    accept="image/*"
                    style="display:none" />
              <button type="button" class="small-btn" id="certPickBtn">ë“±ë¡ì¦ ì—…ë¡œë“œ</button>
            </div>
          </div>
            <div class="inline align-start" style="margin-top:8px">
              <div class="flex-1">
                <div id="certImagePreview" class="thumb"></div>
              </div>
            </div>
          <small id="fileMsg" class="help">ë“±ë¡ì¦ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì£¼ì„¸ìš”.</small>
          <small id="agreeMsg" class="help"></small>
          <button type="button" id="verifyBtn">ì¸ì¦</button>
        </div>

        <!-- ë‹‰ë„¤ì„ -->
        <div class="field">
          <input id="lawyerNickname"
                 name="lawyerNickname"
                 class="input"
                 type="text"
                 th:field="*{lawyerNickname}"
                 placeholder="ë‹‰ë„¤ì„"
                 required>
        </div>

        <!-- ì´ë©”ì¼ -->
        <div class="field">
          <input id="lawyerEmail"
                 name="lawyerEmail"
                 class="input"
                 type="email"
                 th:value="${joinLawyer.lawyerEmail}"
                 readonly>
        </div>

        <!-- ìƒë…„ì›”ì¼(ì£¼ë¯¼ë²ˆí˜¸ ì•ìë¦¬) -->
        <div class="field">
          <input id="lawyerIdnum" 
                name="lawyerIdnum" 
                class="input" 
                type="text" 
                th:field="*{lawyerIdnum}" 
                placeholder="ìƒë…„ì›”ì¼(ì˜ˆ: 990101)" 
                inputmode="numeric" 
                required>
        </div>

        <!-- ì‚¬ë¬´ì‹¤ ì£¼ì†Œ -->
        <div class="field">
          <input id="lawyerAddress"
                 name="lawyerAddress"
                 class="input"
                 type="text"
                 th:field="*{lawyerAddress}"
                 placeholder="ì‚¬ë¬´ì‹¤ ì£¼ì†Œ">
        </div>

        <!-- íœ´ëŒ€í° ë²ˆí˜¸ -->
        <div class="field">
          <input id="lawyerPhone"
                 name="lawyerPhone"
                 class="input"
                 type="tel"
                 th:field="*{lawyerPhone}"
                 placeholder="íœ´ëŒ€í° ë²ˆí˜¸ (ì˜ˆ: 010-1234-5678)"
                 inputmode="numeric"
                 required>
        </div>

        <!-- ì‚¬ë¬´ì‹¤(ì‚¬ì—…ì¥) ì „í™”ë²ˆí˜¸ -->
        <div class="field">
          <input id="lawyerTel"
                 name="lawyerTel"
                 class="input"
                 type="tel"
                 th:field="*{lawyerTel}"
                 placeholder="ì‚¬ë¬´ì‹¤ ì „í™”ë²ˆí˜¸ (ì„ íƒ)"
                 inputmode="numeric">
        </div>

        <!-- ê´€ì‹¬ ë¶„ì•¼ (1ê°œ ì„ íƒ) -->
        <div class="field">
          <select id="interestIdx"
                  name="interestIdx"
                  class="input"
                  th:field="*{interestIdx}"
                  required>
            <option value="" disabled selected>ì „ë¬¸ ë¶„ì•¼ ì„ íƒ</option>
            <option th:each="it : ${interests}"
                    th:value="${it.interestIdx}"
                    th:text="${it.interestName}">
              í˜•ì‚¬
            </option>
          </select>
        </div>

        <!-- í•œì¤„ì†Œê°œ + ì‚¬ì§„ ì—…ë¡œë“œ -->
        <div class="field">
          <div class="inline align-start">
            <div style="display:flex; flex-direction:column; align-items:flex-start; gap:8px; margin-right:-5px;">
              <label class="photo" for="lawyerImage" style="position:relative; overflow:hidden; cursor:pointer;">
                <span id="photoLabelText">ì‚¬ì§„</span>
                <div id="lawyerImagePreview" style="position:absolute; top:0; left:0; width:100%; height:100%; display:none; z-index:1;">
                  <img style="width:100%; height:100%; object-fit:cover;" alt="ë³€í˜¸ì‚¬ ì‚¬ì§„">
                </div>
                <input id="lawyerImage"
                       name="lawyerImage"
                       type="file"
                       accept="image/*"
                       style="display:none" />
              </label>
              <div style="display:flex; align-items:center; gap:8px; margin-top:4px;">
                <button type="button" class="small-btn" id="lawyerImagePickBtn">ë³€í˜¸ì‚¬ ì‚¬ì§„ ì—…ë¡œë“œ</button>
                <div>
                  <input type="hidden" id="lawyerAgree" name="lawyerAgree" th:field="*{lawyerAgree}" value="0">
                  <button class="small-btn" type="button" id="privacyBtn">ê°œì¸ ì •ë³´ ìˆ˜ì‹  ë™ì˜</button>
                </div>
              </div>
              <small id="agreeMsg" class="help" style="margin-top:4px;"></small>
            </div>
            <div class="flex-1">
              <input id="lawyerIntro"
                     name="lawyerComment"
                     class="input"
                     type="text"
                     th:field="*{lawyerComment}"
                     placeholder="í•œì¤„ì†Œê°œ (ì„ íƒ)">
            </div>
          </div>
        </div>

        <!-- ìƒë‹´ ê°€ëŠ¥ ì‹œê°„ JSON (ì„ íƒê°’ ì„œë²„ë¡œ ì „ë‹¬ìš©) -->
        <input type="hidden" id="availabilityJson" name="availabilityJson" value="[]">

        <div class="divider"></div>
        <button class="primary-btn" type="submit" id="submitBtn">íšŒì›ê°€ì…</button>
      </form>
    </section>
  </main>

  <div class="include" th:replace="~{include/footer :: footer}"></div>
  <script th:src="@{/js/js.js}"></script>
  <script th:src="@{/js/chatIcon.js}"></script>
  <script>
    // static/js/lJoin-oauth.js
    (() => {
      const form = document.getElementById('lawyerJoinForm');
      if (!form) return;

      const $ = (id) => document.getElementById(id);
      const digits = (s) => (s || "").replace(/\D/g, "");

      const lawyerPhone = $('lawyerPhone');
      const lawyerIdnum = $('lawyerIdnum');  // ìƒë…„ì›”ì¼
      const lawyerAuth = $('lawyerAuth');
      const interestIdx = $('interestIdx');
      const lawyerAgree = $('lawyerAgree');
      const privacyBtn = $('privacyBtn');
      const agreeMsg = $('agreeMsg');
      const certFile = $('certImage');
      const certPickBtn = $('certPickBtn');
      const certPreview = $('certImagePreview');
      const fileMsg = $('fileMsg');
      const verifyBtn = $('verifyBtn');
      const lawyerImageInput = $('lawyerImage');
      const lawyerImagePickBtn = $('lawyerImagePickBtn');
      const lawyerImagePreview = document.getElementById('lawyerImagePreview');
      const photoLabelText = document.getElementById('photoLabelText');

      // ì „í™”ë²ˆí˜¸ í¬ë§·íŒ…
      const formatPhone = (raw) => {
        const d = digits(raw).slice(0, 11);
        if (d.length <= 3) return d;
        if (d.length <= 7) return `${d.slice(0,3)}-${d.slice(3)}`;
        return `${d.slice(0,3)}-${d.slice(3,7)}-${d.slice(7)}`;
      };

      lawyerPhone?.addEventListener('input', (e) => {
        e.target.value = formatPhone(e.target.value);
      });

      // ìƒë…„ì›”ì¼ ìœ íš¨ì„± ê²€ì‚¬
      const validateBirthDate = (value) => {
        const d = digits(value);
        if (d.length !== 6) return false;
        
        const year = parseInt(d.substring(0, 2));
        const month = parseInt(d.substring(2, 4));
        const day = parseInt(d.substring(4, 6));
        
        if (month < 1 || month > 12) return false;
        if (day < 1 || day > 31) return false;
        
        return true;
      };

      // ë“±ë¡ë²ˆí˜¸ ì…ë ¥ ì‹œ ìˆ«ìë§Œ
      lawyerAuth?.addEventListener('input', (e) => {
        e.target.value = digits(e.target.value);
      });

      // ê°œì¸ì •ë³´ ë™ì˜ í† ê¸€
      privacyBtn?.addEventListener('click', () => {
        if (lawyerAgree.value === "1") {
          lawyerAgree.value = "0";
          privacyBtn.textContent = "ê°œì¸ ì •ë³´ ìˆ˜ì‹  ë™ì˜";
          privacyBtn.classList.remove("complete-btn");
          if (agreeMsg) agreeMsg.textContent = "ê°œì¸ ì •ë³´ ìˆ˜ì‹  ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
        } else {
          lawyerAgree.value = "1";
          privacyBtn.textContent = "ê°œì¸ ì •ë³´ ìˆ˜ì‹  ë™ì˜ ì™„ë£Œ";
          privacyBtn.classList.add("complete-btn");
          if (agreeMsg) agreeMsg.textContent = "";
        }
      });

      // ë“±ë¡ì¦ íŒŒì¼ ì„ íƒ
      certPickBtn?.addEventListener('click', () => certFile.click());

      certFile?.addEventListener('change', () => {
        const f = certFile.files && certFile.files[0];
        certPreview.innerHTML = "";
        if (!f) {
          certPickBtn.textContent = "ë“±ë¡ì¦ ì—…ë¡œë“œ";
          certPickBtn.classList.remove("complete-btn");
          return;
        }

        const url = URL.createObjectURL(f);
        const img = new Image();
        img.onload = () => URL.revokeObjectURL(url);
        img.src = url;
        img.style.maxWidth = "100%";
        img.style.maxHeight = "160px";
        certPreview.appendChild(img);
        
        certPickBtn.textContent = "ë“±ë¡ì¦ ì—…ë¡œë“œ ì™„ë£Œ";
        certPickBtn.classList.add("complete-btn");
        if (fileMsg) fileMsg.textContent = "";
      });

      // ë³€í˜¸ì‚¬ ì‚¬ì§„ ì—…ë¡œë“œ
      lawyerImagePickBtn?.addEventListener('click', () => lawyerImageInput?.click());

      lawyerImageInput?.addEventListener('change', () => {
        const file = lawyerImageInput.files && lawyerImageInput.files[0];
        const previewImg = lawyerImagePreview?.querySelector('img');

        if (!previewImg) return;

        if (!file) {
          lawyerImagePreview.style.display = "none";
          previewImg.removeAttribute('src');
          if (photoLabelText) photoLabelText.textContent = "ì‚¬ì§„";
          return;
        }

        const url = URL.createObjectURL(file);
        previewImg.onload = () => URL.revokeObjectURL(url);
        previewImg.src = url;
        lawyerImagePreview.style.display = "block";
        if (photoLabelText) photoLabelText.textContent = "";
      });

      // ì œì¶œ ê²€ì¦
      form.addEventListener('submit', (e) => {
        const errors = [];

        const regNo = (lawyerIdnum?.value || "").trim();
        const phone = digits(lawyerPhone?.value || "");
        const interest = interestIdx?.value || "";

        // ë“±ë¡ë²ˆí˜¸
        if (!regNo) {
          errors.push("ë“±ë¡ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        }

        // ë“±ë¡ì¦ íŒŒì¼
        if (!certFile.files || !certFile.files.length) {
          errors.push("ë“±ë¡ì¦ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì£¼ì„¸ìš”.");
          if (fileMsg) fileMsg.textContent = "ë“±ë¡ì¦ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì£¼ì„¸ìš”.";
        }

        // OCR ì¸ì¦ í™•ì¸
        if (typeof window.isOcrVerified === 'function' && !window.isOcrVerified()) {
          errors.push("ë“±ë¡ì¦ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.");
          if (verifyBtn) {
            verifyBtn.style.border = "2px solid red";
            setTimeout(() => {
              verifyBtn.style.border = "";
            }, 2000);
          }
        }

        // ì „ë¬¸ ë¶„ì•¼
        if (!interest) {
          errors.push("ì „ë¬¸ ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        }

        // ì „í™”ë²ˆí˜¸
        if (phone.length < 10) {
          errors.push("ì „í™”ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.");
        }

        // ê°œì¸ì •ë³´ ë™ì˜
        if (lawyerAgree.value !== "1") {
          errors.push("ê°œì¸ ì •ë³´ ìˆ˜ì‹  ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.");
          if (agreeMsg) agreeMsg.textContent = "ê°œì¸ ì •ë³´ ìˆ˜ì‹  ë™ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
        }

        if (errors.length > 0) {
          e.preventDefault();
          alert(errors.join("\n"));
          return;
        }

        // ì „ì†¡ ì „ì— ì „í™”ë²ˆí˜¸ í¬ë§· ì •ë¦¬
        if (lawyerPhone) {
          lawyerPhone.value = formatPhone(lawyerPhone.value);
        }
      });
    })();
  </script>
  <script>
    // OCR ê²€ì¦ ì™„ë£Œ í”Œë˜ê·¸
    let ocrVerified = false;

    document.getElementById("verifyBtn").addEventListener("click", async () => {
      const number = document.getElementById("lawyerAuth").value;
      const image = document.getElementById("certImage").files[0];

      if (!number) {
        alert("ë“±ë¡ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      if (!image) {
        alert("ë“±ë¡ì¦ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.");
        return;
      }

      const formData = new FormData();
      formData.append("licenseNumber", number);
      formData.append("licenseImage", image);

      try {
        const res = await fetch("/member/verify-license", {
          method: "POST",
          body: formData
        });

        const result = await res.json();
        console.log("ğŸ” OCR ê²°ê³¼:", result.ocrTexts);

        if (result.valid === true) {
          ocrVerified = true;
          alert((result.message || "ìê²© ê²€ì¦ ì„±ê³µ"));
          
          // ì¸ì¦ ì™„ë£Œ í‘œì‹œ
          document.getElementById("verifyBtn").textContent = "ì¸ì¦ ì™„ë£Œ";
          document.getElementById("verifyBtn").classList.add("complete-btn");
          document.getElementById("verifyBtn").disabled = true;
        } else {
          ocrVerified = false;
          alert((result.error || result.message || "ìê²© ê²€ì¦ ì‹¤íŒ¨. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.") 
              + "\n\nğŸ“„ OCR ì¸ì‹ ê²°ê³¼:\n" + (result.ocrTexts || []).join("\n"));
        }
      } catch (error) {
        console.error("OCR ê²€ì¦ ì˜¤ë¥˜:", error);
        ocrVerified = false;
        alert("ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      }
    });

    // OCR ê²€ì¦ ìƒíƒœë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
    window.isOcrVerified = () => ocrVerified;
  </script>
  <script th:if="${alert}" th:inline="javascript">
        /*<![CDATA[*/
        alert('[[${alert}]]'); // ì „ë‹¬ëœ alert ë©”ì„¸ì§€ ì¶œë ¥
        /*]]>*/
    </script>
</body>
</html>
