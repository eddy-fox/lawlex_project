<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>변호사회원가입</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link rel="stylesheet" th:href="@{/css/lJoin.css}">
</head>
<body>
  <div class="include" th:replace="~{include/header :: header}"></div>

  <!-- 로그인 상태별 마이페이지 진입 버튼 -->
  <div class="wrap" style="display:flex; justify-content:flex-end; gap:8px; margin:12px 0;">
    <a th:if="${session.loginUser != null}"
       class="primary-btn"
       th:href="@{/member/mypage}">
      마이페이지
    </a>
  </div>

  <main class="page-lJoin">
    <section class="center-card">
      <div class="head">
        <h1 class="title">변호사 회원가입</h1>
      </div>

      <!-- 변호사 회원가입 폼 -->
      <form id="lawyerJoinForm" class="form"
            th:action="@{/lawyer/join}"
            method="post"
            enctype="multipart/form-data"
            novalidate>

        <!-- CSRF -->
        <th:block th:if="${_csrf != null}">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        </th:block>

        <!-- 1. 아이디 + 중복확인 (맨 위) -->
        <div class="field">
          <div class="inline">
            <input id="lawyerId"
                   name="lawyerId"
                   class="input"
                   type="text"
                   placeholder="아이디"
                   autocomplete="username"
                   required>
            <button class="pill" type="button" id="dupBtn">중복확인</button>
          </div>
          <small id="dupMsg" class="help"></small>
        </div>

        <!-- 2. 비밀번호 / 비밀번호 확인 -->
        <div class="field">
          <input id="lawyerPass"
                 name="lawyerPass"
                 class="input"
                 type="password"
                 placeholder="비밀번호"
                 autocomplete="new-password"
                 required>
        </div>
        <div class="field">
          <input id="passConfirm"
                 class="input"
                 type="password"
                 placeholder="비밀번호 확인"
                 autocomplete="new-password"
                 required>
          <small id="pwMsg" class="help"></small>
        </div>

        <!-- 3. 이름 (아이디 아래로 내림) -->
        <div class="field">
          <input id="lawyerName"
                 name="lawyerName"
                 class="input"
                 type="text"
                 placeholder="이름"
                 required>
        </div>

        <!-- 4. 등록번호 (이름 아래로 내림) -->
        <div class="field">
          <input id="lawyerAuth"
                 name="lawyerAuth"
                 class="input"
                 type="text"
                 placeholder="등록번호"
                 inputmode="numeric"
                 required>
        </div>
        <div class="field">
          <div class="agree-area">
            <div class="left">
              <!-- 신분증 업로드 제거, 등록증만 유지 -->
              <input id="certImage"
                    name="certImage"
                    type="file"
                    accept="image/*"
                    style="display:none" />
              <button type="button" class="small-btn" id="certPickBtn">등록증 업로드</button>
            </div>
          </div>
            <div class="inline align-start" style="margin-top:8px">
              <div class="flex-1">
                <div id="certImagePreview" class="thumb"></div>
              </div>
            </div>
          <small id="fileMsg" class="help">등록증 이미지를 첨부해주세요.</small>
          <small id="agreeMsg" class="help"></small>
          <button class="small-btn" type="button" id="verifyBtn">인증</button>
        </div>

        <!-- 닉네임 -->
        <div class="field">
          <input id="lawyerNickname"
                 name="lawyerNickname"
                 class="input"
                 type="text"
                 placeholder="닉네임"
                 required>
        </div>

        <!-- 이메일 -->
        <div class="field">
          <input id="lawyerEmail"
                 name="lawyerEmail"
                 class="input"
                 type="email"
                 placeholder="이메일"
                 autocomplete="email"
                 required>
        </div>

        <!-- 생년월일(주민번호 앞자리) -->
        <div class="field">
          <input id="lawyerIdnum" 
                name="lawyerIdnum" 
                class="input" 
                type="text" 
                placeholder="생년월일(예: 990101)" 
                inputmode="numeric" 
                required>
        </div>

        <!-- 사무실 주소 -->
        <div class="field">
          <input id="lawyerAddress"
                 name="lawyerAddress"
                 class="input"
                 type="text"
                 placeholder="사무실 주소">
        </div>

        <!-- 휴대폰 번호 -->
        <div class="field">
          <input id="lawyerPhone"
                 name="lawyerPhone"
                 class="input"
                 type="tel"
                 placeholder="휴대폰 번호 (예: 010-1234-5678)"
                 inputmode="numeric"
                 required>
        </div>

        <!-- 사무실(사업장) 전화번호 -->
        <div class="field">
          <input id="lawyerTel"
                 name="lawyerTel"
                 class="input"
                 type="tel"
                 placeholder="사무실 전화번호 (선택)"
                 inputmode="numeric">
        </div>

        <!-- 관심 분야 (1개 선택) -->
        <div class="field">
          <select id="interestIdx"
                  name="interestIdx"
                  class="input"
                  required>
            <option value="" disabled selected>전문 분야 선택</option>
            <option th:each="it : ${interests}"
                    th:value="${it.interestIdx}"
                    th:text="${it.interestName}">
              형사
            </option>
          </select>
        </div>

        <!-- 한줄소개 + 사진 업로드 -->
        <div class="field">
          <div class="inline align-start">
            <!-- 사진 박스와 버튼들 -->
            <div style="display:flex; flex-direction:column; align-items:flex-start; gap:8px; margin-right:-5px;">
              <label class="photo" for="lawyerImage" style="position:relative; overflow:hidden; cursor:pointer;">
                <span id="photoLabelText">사진</span>
                <div id="lawyerImagePreview" style="position:absolute; top:0; left:0; width:100%; height:100%; display:none; z-index:1;">
                  <img style="width:100%; height:100%; object-fit:cover;" alt="변호사 사진">
                </div>
                <input id="lawyerImage"
                       name="lawyerImage"
                       type="file"
                       accept="image/*"
                       style="display:none" />
              </label>
              <!-- 사진 업로드 버튼과 개인정보 수신동의를 같은 줄에 배치 (현재 위치 고정) -->
              <div style="display:flex; align-items:center; gap:8px; margin-top:4px;">
                <button type="button" class="small-btn" id="lawyerImagePickBtn">변호사 사진 업로드</button>
                <div>
                  <input type="hidden" id="lawyerAgree" name="lawyerAgree" value="0">
                  <button class="small-btn" type="button" id="privacyBtn">개인 정보 수신 동의</button>
                </div>
              </div>
              <small id="agreeMsg" class="help" style="margin-top:4px;"></small>
            </div>
            <div class="flex-1">
              <!-- 한줄소개: lawyerComment 로 name 지정 -->
              <input id="lawyerIntro"
                     name="lawyerComment"
                     class="input"
                     type="text"
                     placeholder="한줄소개 (선택)">
            </div>
          </div>
        </div>

        <!-- 등록증 업로드 -->
        <div class="field">
          <div class="inline align-start" style="margin-top:8px">
            <div class="flex-1">
              <div id="certImagePreview" class="thumb"></div>
            </div>
          </div>
        </div>

        <!-- 상담 가능 시간 JSON (선택값 서버로 전달용) -->
        <input type="hidden" id="availabilityJson" name="availabilityJson" value="[]">

        <div class="divider"></div>
        <button class="primary-btn" type="submit" id="submitBtn">회원가입</button>
      </form>
    </section>
  </main>

  <div class="include" th:replace="~{include/footer :: footer}"></div>
  <script th:src="@{/js/js.js}"></script>
  <script th:src="@{/js/chatIcon.js}"></script>
  <script th:src="@{/js/lJoin.js}"></script>
  <script th:if="${alert}" th:inline="javascript">
        /*<![CDATA[*/
        alert('[[${alert}]]'); // 전달된 alert 메세지 출력
        /*]]>*/
    </script>
  <script>
    // OCR 검증 완료 플래그
    let ocrVerified = false;

    document.getElementById("verifyBtn").addEventListener("click", async () => {
      const number = document.getElementById("lawyerAuth").value;
      const image = document.getElementById("certImage").files[0];

      if (!number) {
        alert("등록번호를 입력해주세요.");
        return;
      }

      if (!image) {
        alert("등록증 이미지를 업로드해주세요.");
        return;
      }

      const formData = new FormData();
      formData.append("licenseNumber", number);
      formData.append("licenseImage", image);

      try {
        const res = await fetch("/member/verify-license", {
          method: "POST",
          body: formData
        });

        const result = await res.json();
        console.log("🔍 OCR 결과:", result.ocrTexts);

        if (result.valid === true) {
          ocrVerified = true;
          alert((result.message || "자격 검증 성공"));
          
          // 인증 완료 표시
          document.getElementById("verifyBtn").textContent = "인증 완료";
          document.getElementById("verifyBtn").classList.add("complete-btn");
          document.getElementById("verifyBtn").disabled = true;
        } else {
          ocrVerified = false;
          alert((result.error || result.message || "자격 검증 실패. 다시 확인해주세요.") 
              + "\n\n📄 OCR 인식 결과:\n" + (result.ocrTexts || []).join("\n"));
        }
      } catch (error) {
        console.error("OCR 검증 오류:", error);
        ocrVerified = false;
        alert("검증 중 오류가 발생했습니다. 다시 시도해주세요.");
      }
    });

    // OCR 검증 상태를 전역으로 노출
    window.isOcrVerified = () => ocrVerified;

    // --- 회원가입 제출 검사 추가 ---
    document.getElementById("lawyerJoinForm").addEventListener("submit", function(e) {

      let errors = [];

      // 🔍 OCR 검증 여부 체크
      if (!ocrVerified) {
        errors.push("등록증 인증을 완료해주세요.");
        const verifyBtn = document.getElementById("verifyBtn");

        if (verifyBtn) {
          verifyBtn.style.border = "2px solid red";
          setTimeout(() => verifyBtn.style.border = "", 2000);
        }
      }

      // 에러가 하나라도 있으면 제출 막기
      if (errors.length > 0) {
        e.preventDefault();
        alert(errors.join("\n"));
        return;
      }
    });
  </script>
</body>
</html>
