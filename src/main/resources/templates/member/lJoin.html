<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ë³€í˜¸ì‚¬íšŒì›ê°€ì…</title>
  <link rel="stylesheet" th:href="@{/css/lJoin.css}">
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
  <div class="include" th:replace="~{include/header :: header}"></div>

  <!-- ë¡œê·¸ì¸ ìƒíƒœë³„ ë§ˆì´í˜ì´ì§€ ì§„ì… ë²„íŠ¼ -->
  <div class="wrap" style="display:flex; justify-content:flex-end; gap:8px; margin:12px 0;">
    <a th:if="${session.loginUser != null}"
       class="primary-btn"
       th:href="@{/member/mypage}">
      ë§ˆì´í˜ì´ì§€
    </a>
    <a th:if="${session.loginUser == null}"
       class="small-btn"
       th:href="@{/member/login(need='mypage')}">
      ë¡œê·¸ì¸í•˜ê³  ë§ˆì´í˜ì´ì§€
    </a>
  </div>

  <main class="page-lJoin">
    <section class="center-card">
      <div class="head">
        <h1 class="title">ë³€í˜¸ì‚¬ íšŒì›ê°€ì…</h1>
      </div>

      <!-- ë³€í˜¸ì‚¬ íšŒì›ê°€ì… í¼ -->
      <form id="lawyerJoinForm" class="form"
            th:action="@{/lawyer/join}"
            method="post"
            enctype="multipart/form-data"
            novalidate>

        <!-- CSRF -->
        <th:block th:if="${_csrf != null}">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        </th:block>

        <!-- 1. ì•„ì´ë”” + ì¤‘ë³µí™•ì¸ (ë§¨ ìœ„) -->
        <div class="field">
          <div class="inline">
            <input id="lawyerId"
                   name="lawyerId"
                   class="input"
                   type="text"
                   placeholder="ì•„ì´ë””"
                   autocomplete="username"
                   required>
            <button class="pill" type="button" id="dupBtn">ì¤‘ë³µí™•ì¸</button>
          </div>
          <small id="dupMsg" class="help"></small>
        </div>

        <!-- 2. ë¹„ë°€ë²ˆí˜¸ / ë¹„ë°€ë²ˆí˜¸ í™•ì¸ -->
        <div class="field">
          <input id="lawyerPass"
                 name="lawyerPass"
                 class="input"
                 type="password"
                 placeholder="ë¹„ë°€ë²ˆí˜¸"
                 autocomplete="new-password"
                 required>
        </div>
        <div class="field">
          <input id="passConfirm"
                 class="input"
                 type="password"
                 placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                 autocomplete="new-password"
                 required>
          <small id="pwMsg" class="help"></small>
        </div>

        <!-- 3. ì´ë¦„ (ì•„ì´ë”” ì•„ë˜ë¡œ ë‚´ë¦¼) -->
        <div class="field">
          <input id="lawyerName"
                 name="lawyerName"
                 class="input"
                 type="text"
                 placeholder="ì´ë¦„"
                 required>
        </div>

        <!-- 4. ë“±ë¡ë²ˆí˜¸ (ì´ë¦„ ì•„ë˜ë¡œ ë‚´ë¦¼) -->
        <div class="field">
          <input id="lawyerIdnum"
                 name="lawyerIdnum"
                 class="input"
                 type="text"
                 placeholder="ë“±ë¡ë²ˆí˜¸"
                 inputmode="numeric"
                 required>
        </div>
        <div class="field">
          <div class="agree-area">
            <div class="left">
              <!-- ì‹ ë¶„ì¦ ì—…ë¡œë“œ ì œê±°, ë“±ë¡ì¦ë§Œ ìœ ì§€ -->
              <input id="certImage"
                    name="certImage"
                    type="file"
                    accept="image/*"
                    style="display:none" />
              <button type="button" class="small-btn" id="certPickBtn">ë“±ë¡ì¦ ì—…ë¡œë“œ</button>
            </div>
          </div>
            <div class="inline align-start" style="margin-top:8px">
              <div class="flex-1">
                <div id="certImagePreview" class="thumb"></div>
              </div>
            </div>
          <small id="fileMsg" class="help">ë“±ë¡ì¦ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì£¼ì„¸ìš”.</small>
          <small id="agreeMsg" class="help"></small>
          <button type="button" id="verifyBtn">ì¸ì¦</button>
        </div>

        <!-- ë‹‰ë„¤ì„ -->
        <div class="field">
          <input id="lawyerNickname"
                 name="lawyerNickname"
                 class="input"
                 type="text"
                 placeholder="ë‹‰ë„¤ì„"
                 required>
        </div>

        <!-- ì´ë©”ì¼ -->
        <div class="field">
          <input id="lawyerEmail"
                 name="lawyerEmail"
                 class="input"
                 type="email"
                 placeholder="ì´ë©”ì¼"
                 autocomplete="email"
                 required>
        </div>

        <!-- ì‚¬ë¬´ì‹¤ ì£¼ì†Œ -->
        <div class="field">
          <input id="lawyerAddress"
                 name="lawyerAddress"
                 class="input"
                 type="text"
                 placeholder="ì‚¬ë¬´ì‹¤ ì£¼ì†Œ">
        </div>

        <!-- íœ´ëŒ€í° ë²ˆí˜¸ -->
        <div class="field">
          <input id="lawyerPhone"
                 name="lawyerPhone"
                 class="input"
                 type="tel"
                 placeholder="íœ´ëŒ€í° ë²ˆí˜¸ (ì˜ˆ: 010-1234-5678)"
                 inputmode="numeric"
                 required>
        </div>

        <!-- ì‚¬ë¬´ì‹¤(ì‚¬ì—…ì¥) ì „í™”ë²ˆí˜¸ -->
        <div class="field">
          <input id="lawyerTel"
                 name="lawyerTel"
                 class="input"
                 type="tel"
                 placeholder="ì‚¬ë¬´ì‹¤ ì „í™”ë²ˆí˜¸ (ì„ íƒ)"
                 inputmode="numeric">
        </div>

        <!-- ê´€ì‹¬ ë¶„ì•¼ (1ê°œ ì„ íƒ) -->
        <div class="field">
          <select id="interestIdx"
                  name="interestIdx"
                  class="input"
                  required>
            <option value="" disabled selected>ì „ë¬¸ ë¶„ì•¼ ì„ íƒ</option>
            <option th:each="it : ${interests}"
                    th:value="${it.interestIdx}"
                    th:text="${it.interestName}">
              í˜•ì‚¬
            </option>
          </select>
        </div>

        <!-- í•œì¤„ì†Œê°œ + ìƒë‹´ ê°€ëŠ¥ ìš”ì¼/ì‹œê°„ -->
        <div class="field">
          <div class="inline align-start">
            <label class="photo">ìƒë‹´ ì•ˆë‚´</label>
            <div class="flex-1">
              <!-- í•œì¤„ì†Œê°œ: lawyerComment ë¡œ name ì§€ì • -->
              <input id="lawyerIntro"
                     name="lawyerComment"
                     class="input"
                     type="text"
                     placeholder="í•œì¤„ì†Œê°œ (ì„ íƒ)">
              <label style="display:block; margin-top:8px;">ìƒë‹´ ê°€ëŠ¥ ìš”ì¼ ë° ì‹œê°„ëŒ€ (ì„ íƒ)</label>
              <div class="days">
                <input type="checkbox" id="mon" value="ì›”"><label for="mon">ì›”</label>
                <input type="checkbox" id="tue" value="í™”"><label for="tue">í™”</label>
                <input type="checkbox" id="wed" value="ìˆ˜"><label for="wed">ìˆ˜</label>
                <input type="checkbox" id="thu" value="ëª©"><label for="thu">ëª©</label>
                <input type="checkbox" id="fri" value="ê¸ˆ"><label for="fri">ê¸ˆ</label>
                <input type="checkbox" id="sat" value="í† "><label for="sat">í† </label>
                <input type="checkbox" id="sun" value="ì¼"><label for="sun">ì¼</label>
              </div>
              <div class="inline" style="margin-top:4px;">
                <input id="timeStart" class="input" type="time" style="flex:1">
                <span style="margin:0 6px">~</span>
                <input id="timeEnd" class="input" type="time" style="flex:1">
              </div>
              <button type="button" class="small-btn" id="addTime" style="margin-top:6px;">ì¶”ê°€</button>
              <div id="selectedList" class="selected-list"></div>
            </div>
          </div>
        </div>

        <!-- ë“±ë¡ì¦ ì—…ë¡œë“œ + ë™ì˜ -->
        <div class="field">
          <div class="agree-area">
            <div class="left">
              <!-- ì‹ ë¶„ì¦ ì—…ë¡œë“œ ì œê±°, ë“±ë¡ì¦ë§Œ ìœ ì§€ -->
              <input id="certImage"
                     name="certImage"
                     type="file"
                     accept="image/*"
                     style="display:none" />
              <button type="button" class="small-btn" id="certPickBtn">ë“±ë¡ì¦ ì—…ë¡œë“œ</button>
            </div>
            <div class="right">
              <!-- í™”ë©´ì—ì„œëŠ” Y/Në¡œ í† ê¸€í•˜ì§€ë§Œ DB ì €ì¥ì€ ì„œë¹„ìŠ¤ì—ì„œ 1ë¡œ ì²˜ë¦¬ -->
              <input type="hidden" id="lawyerAgree" name="lawyerAgree" value="N">
              <button class="small-btn" type="button" id="privacyBtn">ê°œì¸ ì •ë³´ ìˆ˜ì‹  ë™ì˜</button>
            </div>
          </div>

          <div class="inline align-start" style="margin-top:8px">
            <div class="flex-1">
              <div id="certImagePreview" class="thumb"></div>
            </div>
          </div>
          <small id="fileMsg" class="help">ë“±ë¡ì¦ ì´ë¯¸ì§€ë¥¼ ì²¨ë¶€í•´ì£¼ì„¸ìš”.</small>
          <small id="agreeMsg" class="help"></small>
        </div>

        <!-- ìƒë‹´ ê°€ëŠ¥ ì‹œê°„ JSON (ì„ íƒê°’ ì„œë²„ë¡œ ì „ë‹¬ìš©) -->
        <input type="hidden" id="availabilityJson" name="availabilityJson" value="[]">

        <div class="divider"></div>
        <button class="primary-btn" type="submit" id="submitBtn">íšŒì›ê°€ì…</button>
      </form>
    </section>
  </main>

  <div class="include" th:replace="~{include/footer :: footer}"></div>
  <script th:src="@{/js/js.js}"></script>
  <script th:src="@{/js/chatIcon.js}"></script>
  <script th:src="@{/js/lJoin.js}"></script>
  <script th:if="${alert}" th:inline="javascript">
        /*<![CDATA[*/
        alert('[[${alert}]]'); // ì „ë‹¬ëœ alert ë©”ì„¸ì§€ ì¶œë ¥
        /*]]>*/
    </script>
  <script>
    document.getElementById("verifyBtn").addEventListener("click", async () => {
        const number = document.getElementById("lawyerIdnum").value;
        const image = document.getElementById("certImage").files[0];

        const formData = new FormData();
        formData.append("licenseNumber", number);
        formData.append("licenseImage", image);

        const res = await fetch("/member/verify-license", {
            method: "POST",
            body: formData
        });

        const result = await res.json();

        console.log("ğŸ” OCR ê²°ê³¼:", result.ocrTexts);

        if (result.valid === true) {
            alert((result.message || "ìê²© ê²€ì¦ ì„±ê³µ") + "\n\nğŸ“„ OCR ì¸ì‹ ê²°ê³¼:\n" + (result.ocrTexts || []).join("\n"));
            document.getElementById("submitBtn").disabled = false;
        } else {
            alert((result.error || result.message || "ìê²© ê²€ì¦ ì‹¤íŒ¨. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.") 
                + "\n\nğŸ“„ OCR ì¸ì‹ ê²°ê³¼:\n" + (result.ocrTexts || []).join("\n"));
            document.getElementById("submitBtn").disabled = true;
        }
    });
  </script>
</body>
</html>
